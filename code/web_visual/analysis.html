<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æ - TEGç›‘æµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š TEGæ•°æ®åˆ†æç³»ç»Ÿ</h1>
            <p class="subtitle">æ··åˆæ¨¡å¼ - æ•°æ®æ–‡ä»¶åˆ†æä¸å¯è§†åŒ–</p>
            <div class="header-actions">
                <a href="index.html" class="btn btn-outline">
                    <span class="btn-icon">â†</span>
                    <span class="btn-text">è¿”å›é¦–é¡µ</span>
                </a>
                <button id="btnExportReport" class="btn btn-success" onclick="exportReport()" style="display: none;">
                    <span class="btn-icon">ğŸ“„</span>
                    <span class="btn-text">å¯¼å‡ºæŠ¥å‘Š</span>
                </button>
            </div>
        </header>
        
        <!-- å¯¼èˆªèœå• -->
        <nav>
            <a href="index.html" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-text">é¦–é¡µ</span>
            </a>
            <a href="analysis.html" class="nav-link active">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">æ•°æ®åˆ†æ</span>
            </a>
            <a href="realtime.html" class="nav-link">
                <span class="nav-icon">ğŸ“¡</span>
                <span class="nav-text">å®æ—¶ç›‘æµ‹</span>
            </a>
            <a href="dashboard.html" class="nav-link">
                <span class="nav-icon">ğŸ“ˆ</span>
                <span class="nav-text">ä»ªè¡¨æ¿</span>
            </a>
        </nav>
        
        <!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
        <div class="card">
            <h2 class="card-title">ğŸ“ é€‰æ‹©æ•°æ®æ–‡ä»¶</h2>
            <div class="card-content">
                <div class="file-selector">
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fileInput" accept=".csv,.txt" multiple style="display: none;">
                        <div class="upload-icon">ğŸ“‚</div>
                        <h3>ä¸Šä¼ æ•°æ®æ–‡ä»¶</h3>
                        <p>æ”¯æŒCSVæ ¼å¼ï¼Œå¯æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <p class="upload-hint">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <span class="btn-icon">ğŸ“</span>
                            <span class="btn-text">é€‰æ‹©æ–‡ä»¶</span>
                        </button>
                    </div>
                    
                    <div class="file-list" id="fileList" style="display: none;">
                        <h3>å·²é€‰æ‹©æ–‡ä»¶</h3>
                        <div class="files-container" id="filesContainer"></div>
                        <div class="file-actions">
                            <button class="btn btn-success" onclick="analyzeSelectedFiles()">
                                <span class="btn-icon">ğŸ“Š</span>
                                <span class="btn-text">å¼€å§‹åˆ†æ</span>
                            </button>
                            <button class="btn btn-outline" onclick="clearFiles()">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                <span class="btn-text">æ¸…ç©ºåˆ—è¡¨</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="server-files" id="serverFiles" style="display: none;">
                    <h3>æœåŠ¡å™¨æ•°æ®æ–‡ä»¶</h3>
                    <div class="files-container" id="serverFilesContainer"></div>
                </div>
            </div>
        </div>
        
        <!-- åˆ†æé…ç½® -->
        <div class="card" id="analysisConfig" style="display: none;">
            <h2 class="card-title">âš™ï¸ åˆ†æé…ç½®</h2>
            <div class="card-content">
                <div class="config-grid">
                    <div class="form-group">
                        <label for="analysisLoadResistance">è´Ÿè½½ç”µé˜» (Î©):</label>
                        <input type="number" id="analysisLoadResistance" value="10.0" step="0.1" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="analysisTegResistance">TEGå†…é˜» (Î©):</label>
                        <input type="number" id="analysisTegResistance" value="4.0" step="0.1" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="analysisSeebeckCoeff">å¡è´å…‹ç³»æ•° (mV/Â°C):</label>
                        <input type="number" id="analysisSeebeckCoeff" value="40.0" step="0.1" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="analysisSampleRate">é‡‡æ ·ç‡ (Hz):</label>
                        <input type="number" id="analysisSampleRate" value="1.0" step="0.1" class="form-control">
                    </div>
                </div>
                <div class="config-actions">
                    <button class="btn btn-primary" onclick="applyAnalysisConfig()">
                        <span class="btn-icon">ğŸ’¾</span>
                        <span class="btn-text">åº”ç”¨é…ç½®</span>
                    </button>
                    <button class="btn btn-outline" onclick="resetAnalysisConfig()">
                        <span class="btn-icon">ğŸ”„</span>
                        <span class="btn-text">é‡ç½®é…ç½®</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- åˆ†æç»“æœ -->
        <div class="analysis-results" id="analysisResults" style="display: none;">
            <!-- ç»Ÿè®¡æ•°æ® -->
            <div class="card">
                <h2 class="card-title">ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
                <div class="card-content">
                    <div class="stats-grid" id="analysisStats">
                        <!-- ç»Ÿè®¡ä¿¡æ¯ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                    </div>
                </div>
            </div>
            
            <!-- å›¾è¡¨å±•ç¤º -->
            <div class="card">
                <h2 class="card-title">ğŸ“Š æ•°æ®åˆ†æå›¾è¡¨</h2>
                <div class="card-content">
                    <div class="chart-tabs">
                        <div class="tab-buttons">
                            <button class="tab-btn active" data-tab="tab1">æ¸©åº¦ç‰¹æ€§</button>
                            <button class="tab-btn" data-tab="tab2">ç”µå‹ç‰¹æ€§</button>
                            <button class="tab-btn" data-tab="tab3">åŠŸç‡ç‰¹æ€§</button>
                            <button class="tab-btn" data-tab="tab4">ç‰¹æ€§æ›²çº¿</button>
                        </div>
                        
                        <div class="tab-content">
                            <div class="tab-pane active" id="tab1">
                                <div class="chart-row">
                                    <div class="chart-container">
                                        <canvas id="analysisTempChart"></canvas>
                                    </div>
                                    <div class="chart-stats">
                                        <h4>æ¸©åº¦ç»Ÿè®¡</h4>
                                        <div id="tempStats"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane" id="tab2">
                                <div class="chart-row">
                                    <div class="chart-container">
                                        <canvas id="analysisVoltageChart"></canvas>
                                    </div>
                                    <div class="chart-stats">
                                        <h4>ç”µå‹ç»Ÿè®¡</h4>
                                        <div id="voltageStats"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane" id="tab3">
                                <div class="chart-row">
                                    <div class="chart-container">
                                        <canvas id="analysisPowerChart"></canvas>
                                    </div>
                                    <div class="chart-stats">
                                        <h4>åŠŸç‡ç»Ÿè®¡</h4>
                                        <div id="powerStats"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane" id="tab4">
                                <div class="chart-row">
                                    <div class="chart-container">
                                        <canvas id="analysisCharacteristicChart"></canvas>
                                    </div>
                                    <div class="chart-stats">
                                        <h4>ç‰¹æ€§ç»Ÿè®¡</h4>
                                        <div id="characteristicStats"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¯¦ç»†æ•°æ® -->
            <div class="card">
                <h2 class="card-title">ğŸ“‹ è¯¦ç»†æ•°æ®</h2>
                <div class="card-content">
                    <div class="data-controls">
                        <div class="form-group">
                            <label for="dataFilter">ç­›é€‰æ¡ä»¶:</label>
                            <select id="dataFilter" class="form-control" onchange="filterData()">
                                <option value="all">å…¨éƒ¨æ•°æ®</option>
                                <option value="temp_high">æ¸©å·® > 5Â°C</option>
                                <option value="voltage_high">ç”µå‹ > 0.1V</option>
                                <option value="power_high">åŠŸç‡ > 1mW</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dataSort">æ’åºæ–¹å¼:</label>
                            <select id="dataSort" class="form-control" onchange="sortData()">
                                <option value="timestamp">æŒ‰æ—¶é—´</option>
                                <option value="temp_diff">æŒ‰æ¸©å·®</option>
                                <option value="voltage">æŒ‰ç”µå‹</option>
                                <option value="power">æŒ‰åŠŸç‡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dataLimit">æ˜¾ç¤ºæ•°é‡:</label>
                            <input type="number" id="dataLimit" value="50" min="10" max="1000" class="form-control" onchange="updateDataTable()">
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table class="data-table" id="analysisDataTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>æ—¶é—´</th>
                                    <th>çƒ­ç«¯(Â°C)</th>
                                    <th>å†·ç«¯(Â°C)</th>
                                    <th>æ¸©å·®(Â°C)</th>
                                    <th>ç”µå‹(V)</th>
                                    <th>åŠŸç‡(mW)</th>
                                    <th>å¡è´å…‹(mV/Â°C)</th>
                                    <th>æ•ˆç‡(%)</th>
                                </tr>
                            </thead>
                            <tbody id="analysisDataBody">
                                <!-- æ•°æ®ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination" id="pagination">
                        <!-- åˆ†é¡µæ§ä»¶ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                    </div>
                </div>
            </div>
            
            <!-- æŠ¥å‘Šç”Ÿæˆ -->
            <div class="card">
                <h2 class="card-title">ğŸ“„ åˆ†ææŠ¥å‘Š</h2>
                <div class="card-content">
                    <div class="report-section">
                        <h3>æµ‹è¯•æ¦‚è¿°</h3>
                        <div id="reportOverview">
                            <!-- æŠ¥å‘Šæ¦‚è¿°ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <h3>å…³é”®æŒ‡æ ‡</h3>
                        <div id="reportMetrics">
                            <!-- å…³é”®æŒ‡æ ‡ä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                    </div>
                    
                    <div class="report-section">
                        <h3>ç»“è®ºä¸å»ºè®®</h3>
                        <div id="reportConclusion">
                            <!-- ç»“è®ºä¼šåŠ¨æ€æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                    </div>
                    
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="generateReport()">
                            <span class="btn-icon">ğŸ“„</span>
                            <span class="btn-text">ç”ŸæˆæŠ¥å‘Š</span>
                        </button>
                        <button class="btn btn-success" onclick="exportAnalysisData()">
                            <span class="btn-icon">ğŸ“¤</span>
                            <span class="btn-text">å¯¼å‡ºæ•°æ®</span>
                        </button>
                        <button class="btn btn-outline" onclick="saveAnalysisSession()">
                            <span class="btn-icon">ğŸ’¾</span>
                            <span class="btn-text">ä¿å­˜ä¼šè¯</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="footer-content">
                <p class="footer-info">
                    æ•°æ®æ ¼å¼: CSV(æ—¶é—´æˆ³,çƒ­ç«¯æ¸©åº¦,å†·ç«¯æ¸©åº¦,åŸå§‹ç”µå‹,CH1,CH2,CH3) | 
                    æ”¯æŒæ–‡ä»¶: .csv, .txt | 
                    æœ€å¤§æ–‡ä»¶å¤§å°: 10MB
                </p>
            </div>
        </footer>
    </div>
    
    <!-- JavaScriptä»£ç  -->
    <script>
        // å…¨å±€å˜é‡
        let analysisData = [];
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 50;
        let analysisCharts = {};
        let selectedFiles = [];
        
        // DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            setupFileUpload();
            
            // åˆå§‹åŒ–æ ‡ç­¾é¡µ
            setupTabs();
            
            // åŠ è½½æœåŠ¡å™¨æ–‡ä»¶åˆ—è¡¨
            loadServerFiles();
        });
        
        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
            uploadArea.addEventListener('click', function(e) {
                if (e.target !== fileInput) {
                    fileInput.click();
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', function(e) {
                handleFileSelect(e.target.files);
            });
            
            // æ‹–æ”¾åŠŸèƒ½
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#e3f2fd';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files);
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(files) {
            selectedFiles = Array.from(files);
            
            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            displayFileList();
            
            // æ˜¾ç¤ºåˆ†æé…ç½®
            document.getElementById('analysisConfig').style.display = 'block';
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFileList() {
            const container = document.getElementById('filesContainer');
            const fileList = document.getElementById('fileList');
            
            container.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="removeFile(${index})">
                        <span class="btn-icon">ğŸ—‘ï¸</span>
                    </button>
                `;
                container.appendChild(fileItem);
            });
            
            fileList.style.display = 'block';
        }
        
        // ç§»é™¤æ–‡ä»¶
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
            
            if (selectedFiles.length === 0) {
                document.getElementById('fileList').style.display = 'none';
                document.getElementById('analysisConfig').style.display = 'none';
            }
        }
        
        // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
        function clearFiles() {
            selectedFiles = [];
            document.getElementById('fileList').style.display = 'none';
            document.getElementById('analysisConfig').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // è®¾ç½®æ ‡ç­¾é¡µ
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // åŠ è½½æœåŠ¡å™¨æ–‡ä»¶åˆ—è¡¨
        async function loadServerFiles() {
            try {
                const response = await fetch('/api/saved_files');
                const files = await response.json();
                
                if (files.length > 0) {
                    const container = document.getElementById('serverFilesContainer');
                    container.innerHTML = '';
                    
                    files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <div class="file-icon">ğŸ’¾</div>
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                                <div class="file-modified">${new Date(file.modified * 1000).toLocaleString()}</div>
                            </div>
                            <div class="file-actions">
                                <button class="btn btn-sm btn-primary" onclick="loadServerFile('${file.name}')">
                                    <span class="btn-icon">ğŸ“Š</span>
                                    <span class="btn-text">åˆ†æ</span>
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="downloadServerFile('${file.name}')">
                                    <span class="btn-icon">â¬‡ï¸</span>
                                    <span class="btn-text">ä¸‹è½½</span>
                                </button>
                            </div>
                        `;
                        container.appendChild(fileItem);
                    });
                    
                    document.getElementById('serverFiles').style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æœåŠ¡å™¨æ–‡ä»¶
        async function loadServerFile(filename) {
            try {
                const response = await fetch(`/api/export/${filename}`);
                const text = await response.text();
                
                // è§£ææ•°æ®
                const data = parseCSV(text);
                if (data.length > 0) {
                    analysisData = data;
                    filteredData = [...data];
                    
                    // å¼€å§‹åˆ†æ
                    startAnalysis();
                }
            } catch (error) {
                console.error('åŠ è½½æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥:', error);
                alert('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }
        
        // ä¸‹è½½æœåŠ¡å™¨æ–‡ä»¶
        async function downloadServerFile(filename) {
            window.open(`/api/export/${filename}`, '_blank');
        }
        
        // åˆ†æé€‰ä¸­çš„æ–‡ä»¶
        async function analyzeSelectedFiles() {
            if (selectedFiles.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            // è¯»å–å¹¶åˆå¹¶æ‰€æœ‰æ–‡ä»¶
            const allData = [];
            
            for (const file of selectedFiles) {
                try {
                    const text = await readFileAsText(file);
                    const data = parseCSV(text);
                    allData.push(...data);
                } catch (error) {
                    console.error(`è¯»å–æ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                    alert(`è¯»å–æ–‡ä»¶ ${file.name} å¤±è´¥: ${error.message}`);
                    return;
                }
            }
            
            if (allData.length > 0) {
                analysisData = allData;
                filteredData = [...allData];
                
                // å¼€å§‹åˆ†æ
                startAnalysis();
            } else {
                alert('æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
            }
        }
        
        // è¯»å–æ–‡ä»¶ä¸ºæ–‡æœ¬
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function(e) {
                    reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
                };
                reader.readAsText(file);
            });
        }
        
        // è§£æCSVæ•°æ®
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            // æ£€æŸ¥æ•°æ®æ ¼å¼
            const isNewFormat = headers.includes('voltage_raw_mV');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(',');
                const row = {};
                
                if (isNewFormat) {
                    // æ–°æ ¼å¼æ•°æ®
                    row.timestamp = parseFloat(values[0]) || 0;
                    row.hot_temp = parseFloat(values[1]) || 0;
                    row.cold_temp = parseFloat(values[2]) || 0;
                    row.voltage_raw = parseFloat(values[3]) || 0;
                    row.voltage = parseFloat(values[8]) || 0;
                    row.current = parseFloat(values[9]) || 0;
                    row.power = parseFloat(values[10]) || 0;
                    row.seebeck = parseFloat(values[11]) || 0;
                    row.efficiency = parseFloat(values[12]) || 0;
                    row.temp_diff = row.hot_temp - row.cold_temp;
                } else {
                    // æ—§æ ¼å¼æ•°æ®æˆ–ç®€åŒ–æ ¼å¼
                    row.timestamp = parseFloat(values[0]) || Date.now();
                    row.hot_temp = parseFloat(values[1]) || 0;
                    row.cold_temp = parseFloat(values[2]) || 0;
                    row.temp_diff = row.hot_temp - row.cold_temp;
                    row.voltage = parseFloat(values[4]) || 0;
                    row.voltage_raw = row.voltage * 1000;
                    
                    // è®¡ç®—å…¶ä»–å€¼
                    const loadResistance = parseFloat(document.getElementById('analysisLoadResistance').value) || 10.0;
                    row.current = row.voltage / loadResistance * 1000;
                    row.power = row.voltage * row.current;
                    row.seebeck = row.temp_diff !== 0 ? (row.voltage * 1000) / row.temp_diff : 0;
                    
                    // è®¡ç®—æ•ˆç‡
                    if (row.temp_diff > 0.1 && row.hot_temp > 0) {
                        const carnot = 1 - (row.cold_temp + 273.15) / (row.hot_temp + 273.15);
                        row.efficiency = carnot > 0 ? (row.power / 1000) / (carnot * 100) * 100 : 0;
                    } else {
                        row.efficiency = 0;
                    }
                }
                
                data.push(row);
            }
            
            return data;
        }
        
        // å¼€å§‹åˆ†æ
        function startAnalysis() {
            // æ˜¾ç¤ºåˆ†æç»“æœåŒºåŸŸ
            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('btnExportReport').style.display = 'inline-block';
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            calculateStatistics();
            
            // åˆ›å»ºå›¾è¡¨
            createAnalysisCharts();
            
            // æ›´æ–°æ•°æ®è¡¨æ ¼
            updateDataTable();
            
            // ç”ŸæˆæŠ¥å‘Š
            generateReport();
        }
        
        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function calculateStatistics() {
            if (analysisData.length === 0) return;
            
            // æå–æ•°æ®åˆ—
            const hotTemps = analysisData.map(d => d.hot_temp);
            const coldTemps = analysisData.map(d => d.cold_temp);
            const tempDiffs = analysisData.map(d => d.temp_diff);
            const voltages = analysisData.map(d => d.voltage);
            const powers = analysisData.map(d => d.power);
            const seebecks = analysisData.filter(d => Math.abs(d.seebeck) < 1000).map(d => d.seebeck);
            const efficiencies = analysisData.map(d => d.efficiency);
            
            // è®¡ç®—ç»Ÿè®¡å€¼
            const stats = {
                dataPoints: analysisData.length,
                duration: (analysisData[analysisData.length-1].timestamp - analysisData[0].timestamp) / 1000,
                hotTemp: calculateStats(hotTemps, 'Â°C'),
                coldTemp: calculateStats(coldTemps, 'Â°C'),
                tempDiff: calculateStats(tempDiffs, 'Â°C'),
                voltage: calculateStats(voltages, 'V'),
                power: calculateStats(powers, 'mW'),
                seebeck: calculateStats(seebecks, 'mV/Â°C'),
                efficiency: calculateStats(efficiencies, '%')
            };
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            displayStatistics(stats);
        }
        
        // è®¡ç®—ç»Ÿè®¡å€¼
        function calculateStats(data, unit) {
            if (data.length === 0) {
                return {
                    min: `-- ${unit}`,
                    max: `-- ${unit}`,
                    mean: `-- ${unit}`,
                    std: `-- ${unit}`
                };
            }
            
            const min = Math.min(...data);
            const max = Math.max(...data);
            const mean = data.reduce((a, b) => a + b, 0) / data.length;
            const std = Math.sqrt(data.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / data.length);
            
            return {
                min: `${min.toFixed(2)} ${unit}`,
                max: `${max.toFixed(2)} ${unit}`,
                mean: `${mean.toFixed(2)} ${unit}`,
                std: `${std.toFixed(2)} ${unit}`
            };
        }
        
        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        function displayStatistics(stats) {
            const container = document.getElementById('analysisStats');
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">æ•°æ®ç‚¹æ•°</div>
                    <div class="stat-value">${stats.dataPoints}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æµ‹è¯•æ—¶é•¿</div>
                    <div class="stat-value">${stats.duration.toFixed(1)} s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">çƒ­ç«¯æ¸©åº¦</div>
                    <div class="stat-value">${stats.hotTemp.mean}</div>
                    <div class="stat-range">${stats.hotTemp.min} - ${stats.hotTemp.max}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å†·ç«¯æ¸©åº¦</div>
                    <div class="stat-value">${stats.coldTemp.mean}</div>
                    <div class="stat-range">${stats.coldTemp.min} - ${stats.coldTemp.max}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡æ¸©å·®</div>
                    <div class="stat-value">${stats.tempDiff.mean}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡ç”µå‹</div>
                    <div class="stat-value">${stats.voltage.mean}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡åŠŸç‡</div>
                    <div class="stat-value">${stats.power.mean}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¡è´å…‹ç³»æ•°</div>
                    <div class="stat-value">${stats.seebeck.mean}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡æ•ˆç‡</div>
                    <div class="stat-value">${stats.efficiency.mean}</div>
                </div>
            `;
        }
        
        // åˆ›å»ºåˆ†æå›¾è¡¨
        function createAnalysisCharts() {
            // æ—¶é—´åºåˆ—
            const timeLabels = analysisData.map(d => 
                new Date(d.timestamp).toLocaleTimeString()
            );
            
            // æ¸©åº¦å›¾è¡¨
            createAnalysisChart('analysisTempChart', {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'çƒ­ç«¯æ¸©åº¦',
                        data: analysisData.map(d => d.hot_temp),
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: true
                    },
                    {
                        label: 'å†·ç«¯æ¸©åº¦',
                        data: analysisData.map(d => d.cold_temp),
                        borderColor: '#36a2eb',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: true
                    }
                ]
            });
            
            // ç”µå‹å›¾è¡¨
            createAnalysisChart('analysisVoltageChart', {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'å¼€è·¯ç”µå‹',
                        data: analysisData.map(d => d.voltage),
                        borderColor: '#4bc0c0',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: true
                    }
                ]
            });
            
            // åŠŸç‡å›¾è¡¨
            createAnalysisChart('analysisPowerChart', {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'è¾“å‡ºåŠŸç‡',
                        data: analysisData.map(d => d.power),
                        borderColor: '#ff9f40',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        fill: true
                    }
                ]
            });
            
            // ç‰¹æ€§æ›²çº¿å›¾è¡¨
            createAnalysisChart('analysisCharacteristicChart', {
                type: 'scatter',
                datasets: [
                    {
                        label: 'æ¸©å·®-ç”µå‹ç‰¹æ€§',
                        data: analysisData.map(d => ({
                            x: d.temp_diff,
                            y: d.voltage
                        })),
                        borderColor: '#9966ff',
                        backgroundColor: 'rgba(153, 102, 255, 0.5)',
                        pointRadius: 4
                    }
                ]
            }, {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'æ¸©å·® (Â°C)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'ç”µå‹ (V)'
                        }
                    }
                }
            });
        }
        
        // åˆ›å»ºåˆ†æå›¾è¡¨
        function createAnalysisChart(canvasId, chartData, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
            if (analysisCharts[canvasId]) {
                analysisCharts[canvasId].destroy();
            }
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¶é—´'
                        }
                    }
                }
            };
            
            const mergedOptions = { ...defaultOptions, ...options };
            
            analysisCharts[canvasId] = new Chart(ctx, {
                type: chartData.type || 'line',
                data: chartData,
                options: mergedOptions
            });
        }
        
        // æ›´æ–°æ•°æ®è¡¨æ ¼
        function updateDataTable() {
            const tbody = document.getElementById('analysisDataBody');
            const pagination = document.getElementById('pagination');
            
            // è®¡ç®—åˆ†é¡µ
            pageSize = parseInt(document.getElementById('dataLimit').value) || 50;
            const totalPages = Math.ceil(filteredData.length / pageSize);
            
            // ç¡®ä¿å½“å‰é¡µé¢æœ‰æ•ˆ
            if (currentPage > totalPages) {
                currentPage = totalPages || 1;
            }
            
            // è·å–å½“å‰é¡µæ•°æ®
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // æ¸…ç©ºè¡¨æ ¼
            tbody.innerHTML = '';
            
            // å¡«å……æ•°æ®
            pageData.forEach((data, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td>${new Date(data.timestamp).toLocaleTimeString()}</td>
                    <td>${data.hot_temp.toFixed(2)}</td>
                    <td>${data.cold_temp.toFixed(2)}</td>
                    <td>${data.temp_diff.toFixed(2)}</td>
                    <td>${data.voltage.toFixed(3)}</td>
                    <td>${data.power.toFixed(2)}</td>
                    <td>${data.seebeck.toFixed(2)}</td>
                    <td>${data.efficiency.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePagination(pagination, totalPages);
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination(element, totalPages) {
            element.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevButton = document.createElement('button');
            prevButton.className = 'btn btn-sm btn-outline';
            prevButton.innerHTML = 'ä¸Šä¸€é¡µ';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateDataTable();
                }
            };
            element.appendChild(prevButton);
            
            // é¡µç æ˜¾ç¤º
            const pageInfo = document.createElement('span');
            pageInfo.className = 'page-info';
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
            element.appendChild(pageInfo);
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextButton = document.createElement('button');
            nextButton.className = 'btn btn-sm btn-outline';
            nextButton.innerHTML = 'ä¸‹ä¸€é¡µ';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateDataTable();
                }
            };
            element.appendChild(nextButton);
        }
        
        // ç­›é€‰æ•°æ®
        function filterData() {
            const filterType = document.getElementById('dataFilter').value;
            
            filteredData = analysisData.filter(data => {
                switch (filterType) {
                    case 'temp_high':
                        return data.temp_diff > 5;
                    case 'voltage_high':
                        return data.voltage > 0.1;
                    case 'power_high':
                        return data.power > 1;
                    default:
                        return true; // å…¨éƒ¨æ•°æ®
                }
            });
            
            currentPage = 1;
            updateDataTable();
        }
        
        // æ’åºæ•°æ®
        function sortData() {
            const sortType = document.getElementById('dataSort').value;
            
            filteredData.sort((a, b) => {
                switch (sortType) {
                    case 'timestamp':
                        return a.timestamp - b.timestamp;
                    case 'temp_diff':
                        return b.temp_diff - a.temp_diff;
                    case 'voltage':
                        return b.voltage - a.voltage;
                    case 'power':
                        return b.power - a.power;
                    default:
                        return 0;
                }
            });
            
            currentPage = 1;
            updateDataTable();
        }
        
        // ç”ŸæˆæŠ¥å‘Š
        function generateReport() {
            if (analysisData.length === 0) return;
            
            // è®¡ç®—æŠ¥å‘Šæ•°æ®
            const hotTempMean = analysisData.reduce((sum, d) => sum + d.hot_temp, 0) / analysisData.length;
            const coldTempMean = analysisData.reduce((sum, d) => sum + d.cold_temp, 0) / analysisData.length;
            const tempDiffMean = analysisData.reduce((sum, d) => sum + d.temp_diff, 0) / analysisData.length;
            const voltageMean = analysisData.reduce((sum, d) => sum + d.voltage, 0) / analysisData.length;
            const powerMean = analysisData.reduce((sum, d) => sum + d.power, 0) / analysisData.length;
            const powerMax = Math.max(...analysisData.map(d => d.power));
            const seebeckMean = analysisData.filter(d => Math.abs(d.seebeck) < 1000)
                .reduce((sum, d) => sum + d.seebeck, 0) / analysisData.length;
            
            // æ›´æ–°æŠ¥å‘Šæ¦‚è¿°
            document.getElementById('reportOverview').innerHTML = `
                <p>æœ¬æ¬¡æµ‹è¯•å…±é‡‡é›†äº† <strong>${analysisData.length}</strong> ä¸ªæ•°æ®ç‚¹ï¼Œ
                æµ‹è¯•æ—¶é•¿ä¸º <strong>${((analysisData[analysisData.length-1].timestamp - analysisData[0].timestamp) / 1000).toFixed(1)}</strong> ç§’ã€‚</p>
                <p>æµ‹è¯•æœŸé—´çƒ­ç«¯å¹³å‡æ¸©åº¦ä¸º <strong>${hotTempMean.toFixed(2)}Â°C</strong>ï¼Œ
                å†·ç«¯å¹³å‡æ¸©åº¦ä¸º <strong>${coldTempMean.toFixed(2)}Â°C</strong>ï¼Œ
                å¹³å‡æ¸©å·®ä¸º <strong>${tempDiffMean.toFixed(2)}Â°C</strong>ã€‚</p>
            `;
            
            // æ›´æ–°å…³é”®æŒ‡æ ‡
            document.getElementById('reportMetrics').innerHTML = `
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">æœ€å¤§è¾“å‡ºåŠŸç‡</div>
                        <div class="metric-value">${powerMax.toFixed(2)} mW</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">å¹³å‡è¾“å‡ºåŠŸç‡</div>
                        <div class="metric-value">${powerMean.toFixed(2)} mW</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">å¹³å‡å¼€è·¯ç”µå‹</div>
                        <div class="metric-value">${voltageMean.toFixed(3)} V</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">å¡è´å…‹ç³»æ•°</div>
                        <div class="metric-value">${seebeckMean.toFixed(2)} mV/Â°C</div>
                    </div>
                </div>
            `;
            
            // æ›´æ–°ç»“è®ºä¸å»ºè®®
            document.getElementById('reportConclusion').innerHTML = `
                <p>æ ¹æ®æµ‹è¯•æ•°æ®åˆ†æï¼ŒTEGæ¨¡å—åœ¨ <strong>${tempDiffMean.toFixed(2)}Â°C</strong> æ¸©å·®ä¸‹ï¼Œ
                èƒ½å¤Ÿäº§ç”Ÿ <strong>${voltageMean.toFixed(3)}V</strong> çš„å¼€è·¯ç”µå‹ï¼Œ
                æœ€å¤§è¾“å‡ºåŠŸç‡è¾¾åˆ° <strong>${powerMax.toFixed(2)}mW</strong>ã€‚</p>
                <p><strong>å»ºè®®:</strong></p>
                <ul>
                    <li>å¢å¤§æ¸©å·®å¯æ˜¾è‘—æé«˜è¾“å‡ºåŠŸç‡</li>
                    <li>ä¼˜åŒ–çƒ­ç«¯æ•£çƒ­è®¾è®¡ï¼Œæé«˜çƒ­ä¼ å¯¼æ•ˆç‡</li>
                    <li>æ ¹æ®è´Ÿè½½ç‰¹æ€§åŒ¹é…æœ€ä½³è´Ÿè½½ç”µé˜»</li>
                    <li>è€ƒè™‘å¤šç‰‡TEGä¸²è”æˆ–å¹¶è”ä»¥æé«˜ç”µå‹æˆ–ç”µæµ</li>
                </ul>
            `;
        }
        
        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport() {
            const reportContent = `
                TEGæ¸©å·®å‘ç”µæµ‹è¯•æŠ¥å‘Š
                ====================
                
                æµ‹è¯•æ¦‚è¿°
                --------
                ${document.getElementById('reportOverview').textContent}
                
                å…³é”®æŒ‡æ ‡
                --------
                ${document.getElementById('reportMetrics').textContent}
                
                ç»“è®ºä¸å»ºè®®
                ----------
                ${document.getElementById('reportConclusion').textContent}
                
                æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}
                æ•°æ®ç‚¹æ•°: ${analysisData.length}
                æµ‹è¯•æ—¶é•¿: ${((analysisData[analysisData.length-1].timestamp - analysisData[0].timestamp) / 1000).toFixed(1)} ç§’
            `;
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `teg_report_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // å¯¼å‡ºåˆ†ææ•°æ®
        function exportAnalysisData() {
            if (analysisData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const headers = ['æ—¶é—´æˆ³', 'çƒ­ç«¯æ¸©åº¦(Â°C)', 'å†·ç«¯æ¸©åº¦(Â°C)', 'æ¸©å·®(Â°C)', 'å¼€è·¯ç”µå‹(V)', 'ç”µæµ(mA)', 'åŠŸç‡(mW)', 'å¡è´å…‹ç³»æ•°(mV/Â°C)', 'æ•ˆç‡(%)'];
            const rows = analysisData.map(d => [
                d.timestamp,
                d.hot_temp.toFixed(2),
                d.cold_temp.toFixed(2),
                d.temp_diff.toFixed(2),
                d.voltage.toFixed(3),
                d.current.toFixed(1),
                d.power.toFixed(2),
                d.seebeck.toFixed(2),
                d.efficiency.toFixed(2)
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `teg_analysis_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ä¿å­˜åˆ†æä¼šè¯
        function saveAnalysisSession() {
            const sessionData = {
                files: selectedFiles.map(f => f.name),
                config: {
                    loadResistance: document.getElementById('analysisLoadResistance').value,
                    tegResistance: document.getElementById('analysisTegResistance').value,
                    seebeckCoeff: document.getElementById('analysisSeebeckCoeff').value,
                    sampleRate: document.getElementById('analysisSampleRate').value
                },
                analysisData: analysisData,
                timestamp: Date.now()
            };
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('teg_analysis_session', JSON.stringify(sessionData));
            alert('åˆ†æä¼šè¯å·²ä¿å­˜');
        }
        
        // åº”ç”¨åˆ†æé…ç½®
        function applyAnalysisConfig() {
            alert('é…ç½®å·²åº”ç”¨');
        }
        
        // é‡ç½®åˆ†æé…ç½®
        function resetAnalysisConfig() {
            document.getElementById('analysisLoadResistance').value = '10.0';
            document.getElementById('analysisTegResistance').value = '4.0';
            document.getElementById('analysisSeebeckCoeff').value = '40.0';
            document.getElementById('analysisSampleRate').value = '1.0';
            alert('é…ç½®å·²é‡ç½®');
        }
    </script>
</body>
</html>