<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEGæ¸©å·®å‘ç”µç›‘æµ‹ç³»ç»Ÿ - æ··åˆæ¨¡å¼</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- ç½‘ç«™æ ‡é¢˜ -->
        <header>
            <h1>ğŸŒ¡ï¸ TEGæ¸©å·®å‘ç”µç›‘æµ‹ç³»ç»Ÿ</h1>
            <p class="subtitle">æ··åˆæ¨¡å¼ - èŠ‚èƒ½å‡æ’ç«èµ›é¡¹ç›®</p>
            <p class="version">ç‰ˆæœ¬: 2.0 | æ•°æ®æ ¼å¼: CSV(æ—¶é—´æˆ³,çƒ­ç«¯æ¸©åº¦,å†·ç«¯æ¸©åº¦,ç”µå‹,CH1,CH2,CH3)</p>
        </header>
        
        <!-- å¯¼èˆªèœå• -->
        <nav>
            <a href="index.html" class="nav-link active">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-text">é¦–é¡µ</span>
            </a>
            <a href="analysis.html" class="nav-link">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">æ•°æ®åˆ†æ</span>
            </a>
            <a href="realtime.html" class="nav-link">
                <span class="nav-icon">ğŸ“¡</span>
                <span class="nav-text">å®æ—¶ç›‘æµ‹</span>
            </a>
            <a href="dashboard.html" class="nav-link">
                <span class="nav-icon">ğŸ“ˆ</span>
                <span class="nav-text">ä»ªè¡¨æ¿</span>
            </a>
        </nav>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <span class="status-label">æœåŠ¡å™¨:</span>
                <span class="status-value" id="serverStatus">ç¦»çº¿</span>
            </div>
            <div class="status-item">
                <span class="status-label">ä¸²å£:</span>
                <span class="status-value" id="serialStatus">æ–­å¼€</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ•°æ®ç‚¹:</span>
                <span class="status-value" id="dataCount">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">é‡‡æ ·ç‡:</span>
                <span class="status-value" id="sampleRate">0.0 Hz</span>
            </div>
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒº -->
        <main>
            <div class="card">
                <h2 class="card-title">ğŸš€ ç³»ç»Ÿæ¦‚è¿°</h2>
                <div class="card-content">
                    <p>æœ¬ç³»ç»Ÿé‡‡ç”¨æ··åˆæ¨¡å¼æ¶æ„ï¼Œç»“åˆäº†Arduinoæ•°æ®é‡‡é›†ã€Pythonæ•°æ®å¤„ç†å’ŒWebå¯è§†åŒ–å±•ç¤ºã€‚</p>
                    
                    <div class="feature-list">
                        <div class="feature-item">
                            <div class="feature-icon">âš¡</div>
                            <div class="feature-content">
                                <h3>é«˜æ•ˆæ•°æ®é‡‡é›†</h3>
                                <p>Arduinoä»…é‡‡é›†åŸå§‹æ•°æ®ï¼Œå‡å°‘è®¡ç®—è´Ÿè½½ï¼Œæ”¯æŒå¤šé€šé“æ‰©å±•</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">ğŸ“ˆ</div>
                            <div class="feature-content">
                                <h3>æ™ºèƒ½æ•°æ®å¤„ç†</h3>
                                <p>Pythonåç«¯è¿›è¡Œæ•°æ®è®¡ç®—ã€åˆ†æå’Œå­˜å‚¨ï¼Œæ”¯æŒå®æ—¶å¤„ç†</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">ğŸŒ</div>
                            <div class="feature-content">
                                <h3>ä¸°å¯Œå¯è§†åŒ–</h3>
                                <p>å“åº”å¼Webç•Œé¢ï¼Œæ”¯æŒå¤šå›¾è¡¨å±•ç¤ºå’Œå®æ—¶æ•°æ®ç›‘æ§</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">ğŸ”§</div>
                            <div class="feature-content">
                                <h3>æ˜“äºæ‰©å±•</h3>
                                <p>æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒåŠŸç‡-è´Ÿè½½æ•°æ®ç»„ç­‰æ‰©å±•åŠŸèƒ½</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">ğŸ¯ æŠ€æœ¯è§„æ ¼</h2>
                <div class="card-content">
                    <div class="spec-grid">
                        <div class="spec-item">
                            <span class="spec-label">ç¡¬ä»¶å¹³å°</span>
                            <span class="spec-value">Arduino Nano + ADS1115 + DS18B20</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">æ•°æ®æ ¼å¼</span>
                            <span class="spec-value">CSV (æ—¶é—´æˆ³,çƒ­ç«¯æ¸©åº¦,å†·ç«¯æ¸©åº¦,ç”µå‹...)</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">é‡‡æ ·ç‡</span>
                            <span class="spec-value">1-10 Hz (å¯é…ç½®)</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">æµ‹é‡èŒƒå›´</span>
                            <span class="spec-value">ç”µå‹: Â±2.048V, æ¸©åº¦: -55~125Â°C</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">é€šä¿¡æ¥å£</span>
                            <span class="spec-value">USBä¸²å£ + WebSocket + REST API</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">æ‰©å±•æ¥å£</span>
                            <span class="spec-value">é¢„ç•™3ä¸ªADCé€šé“ï¼Œæ”¯æŒç”µæµ/è´Ÿè½½ç›‘æµ‹</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">ğŸš¦ å¿«é€Ÿå¼€å§‹</h2>
                <div class="card-content">
                    <ol class="quick-start">
                        <li>
                            <span class="step-number">1</span>
                            <span class="step-text">ä¸Šä¼  <code>monitor_v2.ino</code> åˆ°Arduino</span>
                        </li>
                        <li>
                            <span class="step-number">2</span>
                            <span class="step-text">è¿è¡Œ <code>teg_server_hybrid.py</code> å¯åŠ¨æœåŠ¡å™¨</span>
                        </li>
                        <li>
                            <span class="step-number">3</span>
                            <span class="step-text">æ‰“å¼€æµè§ˆå™¨è®¿é—® <code>http://localhost:5000</code></span>
                        </li>
                        <li>
                            <span class="step-number">4</span>
                            <span class="step-text">è¿æ¥ä¸²å£å¹¶å¼€å§‹æ•°æ®é‡‡é›†</span>
                        </li>
                    </ol>
                    
                    <div class="action-buttons">
                        <a href="realtime.html" class="btn btn-primary">
                            <span class="btn-icon">â–¶ï¸</span>
                            <span class="btn-text">å¼€å§‹å®æ—¶ç›‘æµ‹</span>
                        </a>
                        <a href="analysis.html" class="btn btn-secondary">
                            <span class="btn-icon">ğŸ“Š</span>
                            <span class="btn-text">æ•°æ®åˆ†æ</span>
                        </a>
                        <a href="dashboard.html" class="btn btn-success">
                            <span class="btn-icon">ğŸ“ˆ</span>
                            <span class="btn-text">ä»ªè¡¨æ¿</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">ğŸ“‹ ç³»ç»ŸçŠ¶æ€</h2>
                <div class="card-content">
                    <div class="system-status" id="systemStatus">
                        <div class="status-loading">
                            <div class="loading-spinner"></div>
                            <span>æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- é¡µè„š -->
        <footer>
            <div class="footer-content">
                <p class="copyright">Â© 2023 èŠ‚èƒ½å‡æ’ç«èµ› - TEGæ¸©å·®å‘ç”µèƒ½é‡æ”¶é›†é¡¹ç›®</p>
                <p class="footer-info">ç‰ˆæœ¬: 2.0 | æœ€åæ›´æ–°: <span id="lastUpdateTime">æ­£åœ¨è·å–...</span></p>
            </div>
        </footer>
    </div>
    
    <!-- JavaScriptä»£ç  -->
    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let serverConnected = false;
        let lastUpdateTime = null;
        
        // DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
            updateTime();
            setInterval(updateTime, 1000);
            
            // è¿æ¥WebSocketæœåŠ¡å™¨
            connectWebSocket();
            
            // è·å–ç³»ç»ŸçŠ¶æ€
            fetchSystemStatus();
        });
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('lastUpdateTime').textContent = timeStr;
            lastUpdateTime = now;
        }
        
        // è¿æ¥WebSocketæœåŠ¡å™¨
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                serverConnected = true;
                updateServerStatus('åœ¨çº¿');
                
                // è¯·æ±‚æœ€æ–°æ•°æ®
                socket.send(JSON.stringify({
                    type: 'request_data',
                    n_points: 10
                }));
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
                }
            };
            
            socket.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateServerStatus('é”™è¯¯');
            };
            
            socket.onclose = function() {
                console.log('WebSocketè¿æ¥å…³é—­');
                serverConnected = false;
                updateServerStatus('ç¦»çº¿');
                
                // 5ç§’åå°è¯•é‡è¿
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            if (data.type === 'new_data') {
                // æ–°æ•°æ®
                updateDataDisplay(data.data);
            } else if (data.type === 'status_update') {
                // çŠ¶æ€æ›´æ–°
                updateSystemStatus(data.status);
            } else if (data.type === 'data_response') {
                // æ•°æ®å“åº”
                if (data.data && data.data.length > 0) {
                    updateDataDisplay(data.data[data.data.length - 1]);
                }
            }
        }
        
        // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º
        function updateServerStatus(status) {
            const statusElement = document.getElementById('serverStatus');
            statusElement.textContent = status;
            
            switch (status) {
                case 'åœ¨çº¿':
                    statusElement.className = 'status-value status-online';
                    break;
                case 'ç¦»çº¿':
                    statusElement.className = 'status-value status-offline';
                    break;
                case 'é”™è¯¯':
                    statusElement.className = 'status-value status-error';
                    break;
                default:
                    statusElement.className = 'status-value';
            }
        }
        
        // æ›´æ–°æ•°æ®æ˜¾ç¤º
        function updateDataDisplay(data) {
            // æ›´æ–°æ•°æ®è®¡æ•°
            document.getElementById('dataCount').textContent = data.data_points || 0;
            
            // æ›´æ–°é‡‡æ ·ç‡
            if (data.sample_rate) {
                document.getElementById('sampleRate').textContent = data.sample_rate.toFixed(1) + ' Hz';
            }
            
            // æ›´æ–°ä¸²å£çŠ¶æ€
            if (data.serial_connected !== undefined) {
                const serialStatus = document.getElementById('serialStatus');
                serialStatus.textContent = data.serial_connected ? 'å·²è¿æ¥' : 'æ–­å¼€';
                serialStatus.className = data.serial_connected ? 'status-value status-online' : 'status-value status-offline';
            }
        }
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(status) {
            const statusElement = document.getElementById('systemStatus');
            
            let html = '';
            if (status === 'connected') {
                html = `
                    <div class="status-connected">
                        <div class="status-icon">âœ…</div>
                        <div class="status-details">
                            <h3>ç³»ç»Ÿæ­£å¸¸è¿è¡Œ</h3>
                            <p>æ‰€æœ‰ç»„ä»¶å·¥ä½œæ­£å¸¸ï¼Œå¯ä»¥å¼€å§‹æ•°æ®é‡‡é›†</p>
                        </div>
                    </div>
                `;
            } else if (status === 'disconnected') {
                html = `
                    <div class="status-disconnected">
                        <div class="status-icon">âŒ</div>
                        <div class="status-details">
                            <h3>ç³»ç»Ÿæœªè¿æ¥</h3>
                            <p>è¯·æ£€æŸ¥Arduinoè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€</p>
                        </div>
                    </div>
                `;
            }
            
            statusElement.innerHTML = html;
        }
        
        // è·å–ç³»ç»ŸçŠ¶æ€
        async function fetchSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.status === 'running') {
                    updateSystemStatus('connected');
                } else {
                    updateSystemStatus('disconnected');
                }
            } catch (error) {
                console.error('è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
                updateSystemStatus('disconnected');
            }
        }
        
        // å‘é€WebSocketæ¶ˆæ¯
        function sendWebSocketMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            } else {
                console.error('WebSocketæœªè¿æ¥');
            }
        }
        
        // å¼€å§‹æ•°æ®é‡‡é›†
        function startAcquisition() {
            sendWebSocketMessage({
                type: 'start_acquisition'
            });
        }
        
        // åœæ­¢æ•°æ®é‡‡é›†
        function stopAcquisition() {
            sendWebSocketMessage({
                type: 'stop_acquisition'
            });
        }
    </script>
</body>
</html>