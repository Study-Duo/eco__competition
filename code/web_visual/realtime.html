<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ç›‘æµ‹ - TEGç›‘æµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“¡ TEGå®æ—¶ç›‘æµ‹ç³»ç»Ÿ</h1>
            <p class="subtitle">æ··åˆæ¨¡å¼ - å®æ—¶æ•°æ®é‡‡é›†ä¸å¯è§†åŒ–</p>
            <div class="header-actions">
                <a href="index.html" class="btn btn-outline">
                    <span class="btn-icon">â†</span>
                    <span class="btn-text">è¿”å›é¦–é¡µ</span>
                </a>
                <button id="btnFullscreen" class="btn btn-secondary" onclick="toggleFullscreen()">
                    <span class="btn-icon">ğŸ“º</span>
                    <span class="btn-text">å…¨å±</span>
                </button>
            </div>
        </header>
        
        <!-- å¯¼èˆªèœå• -->
        <nav>
            <a href="index.html" class="nav-link">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-text">é¦–é¡µ</span>
            </a>
            <a href="analysis.html" class="nav-link">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text">æ•°æ®åˆ†æ</span>
            </a>
            <a href="realtime.html" class="nav-link active">
                <span class="nav-icon">ğŸ“¡</span>
                <span class="nav-text">å®æ—¶ç›‘æµ‹</span>
            </a>
            <a href="dashboard.html" class="nav-link">
                <span class="nav-icon">ğŸ“ˆ</span>
                <span class="nav-text">ä»ªè¡¨æ¿</span>
            </a>
        </nav>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="card">
                <h2 class="card-title">âš™ï¸ æ§åˆ¶é¢æ¿</h2>
                <div class="card-content">
                    <div class="control-section">
                        <h3>ä¸²å£è¿æ¥</h3>
                        <div class="control-group">
                            <label for="portSelect">ç«¯å£:</label>
                            <select id="portSelect" class="form-control">
                                <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="baudrateSelect">æ³¢ç‰¹ç‡:</label>
                            <select id="baudrateSelect" class="form-control">
                                <option value="9600">9600</option>
                                <option value="115200" selected>115200</option>
                                <option value="230400">230400</option>
                            </select>
                        </div>
                        <div class="btn-group">
                            <button id="btnConnect" class="btn btn-primary" onclick="connectSerial()">
                                <span class="btn-icon">ğŸ”Œ</span>
                                <span class="btn-text">è¿æ¥</span>
                            </button>
                            <button id="btnDisconnect" class="btn btn-danger" onclick="disconnectSerial()" disabled>
                                <span class="btn-icon">ğŸ”Œ</span>
                                <span class="btn-text">æ–­å¼€</span>
                            </button>
                            <button id="btnRefreshPorts" class="btn btn-secondary" onclick="refreshPorts()">
                                <span class="btn-icon">ğŸ”„</span>
                                <span class="btn-text">åˆ·æ–°</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h3>æ•°æ®é‡‡é›†</h3>
                        <div class="btn-group">
                            <button id="btnStart" class="btn btn-success" onclick="startAcquisition()" disabled>
                                <span class="btn-icon">â–¶ï¸</span>
                                <span class="btn-text">å¼€å§‹</span>
                            </button>
                            <button id="btnStop" class="btn btn-danger" onclick="stopAcquisition()" disabled>
                                <span class="btn-icon">â¹ï¸</span>
                                <span class="btn-text">åœæ­¢</span>
                            </button>
                            <button id="btnClear" class="btn btn-warning" onclick="clearData()">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                <span class="btn-text">æ¸…ç©º</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h3>æ•°æ®è®°å½•</h3>
                        <div class="btn-group">
                            <button id="btnStartLogging" class="btn btn-info" onclick="startLogging()" disabled>
                                <span class="btn-icon">ğŸ’¾</span>
                                <span class="btn-text">è®°å½•</span>
                            </button>
                            <button id="btnStopLogging" class="btn btn-secondary" onclick="stopLogging()" disabled>
                                <span class="btn-icon">â¸ï¸</span>
                                <span class="btn-text">æš‚åœ</span>
                            </button>
                            <button id="btnExportData" class="btn btn-outline" onclick="exportData()" disabled>
                                <span class="btn-icon">ğŸ“¤</span>
                                <span class="btn-text">å¯¼å‡º</span>
                            </button>
                        </div>
                        <div class="file-info">
                            <span class="file-label">å½“å‰æ–‡ä»¶:</span>
                            <span id="currentFileName" class="file-name">æœªè®°å½•</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">ğŸ“Š å®æ—¶ç»Ÿè®¡</h2>
                <div class="card-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">æ•°æ®ç‚¹æ•°</div>
                            <div class="stat-value" id="statDataPoints">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">é‡‡æ ·ç‡</div>
                            <div class="stat-value" id="statSampleRate">0.0 Hz</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">è¿è¡Œæ—¶é—´</div>
                            <div class="stat-value" id="statUptime">00:00:00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">é”™è¯¯æ•°</div>
                            <div class="stat-value" id="statErrors">0</div>
                        </div>
                    </div>
                    
                    <div class="status-indicator">
                        <div class="status-label">è¿æ¥çŠ¶æ€:</div>
                        <div class="status-indicators">
                            <div class="indicator-item">
                                <div class="indicator-dot" id="indicatorServer"></div>
                                <span class="indicator-label">æœåŠ¡å™¨</span>
                            </div>
                            <div class="indicator-item">
                                <div class="indicator-dot" id="indicatorSerial"></div>
                                <span class="indicator-label">ä¸²å£</span>
                            </div>
                            <div class="indicator-item">
                                <div class="indicator-dot" id="indicatorAcquisition"></div>
                                <span class="indicator-label">é‡‡é›†</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶æ•°æ®ä»ªè¡¨æ¿ -->
        <div class="dashboard">
            <!-- æ¸©åº¦ç›‘æ§ -->
            <div class="card chart-card">
                <div class="card-header">
                    <h2 class="card-title">ğŸŒ¡ï¸ æ¸©åº¦ç›‘æ§</h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline" onclick="toggleChart('tempChart')">
                            <span class="btn-icon">ğŸ“Š</span>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                    <div class="metric-row">
                        <div class="metric">
                            <div class="metric-label">çƒ­ç«¯æ¸©åº¦</div>
                            <div class="metric-value" id="metricHotTemp">--.-- Â°C</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">å†·ç«¯æ¸©åº¦</div>
                            <div class="metric-value" id="metricColdTemp">--.-- Â°C</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">æ¸©å·®</div>
                            <div class="metric-value" id="metricTempDiff">--.-- Â°C</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç”µå‹ç›‘æ§ -->
            <div class="card chart-card">
                <div class="card-header">
                    <h2 class="card-title">âš¡ ç”µå‹ç›‘æ§</h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline" onclick="toggleChart('voltageChart')">
                            <span class="btn-icon">ğŸ“Š</span>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="voltageChart"></canvas>
                    </div>
                    <div class="metric-row">
                        <div class="metric">
                            <div class="metric-label">å¼€è·¯ç”µå‹</div>
                            <div class="metric-value" id="metricVoltage">--.-- V</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">åŸå§‹ç”µå‹</div>
                            <div class="metric-value" id="metricVoltageRaw">--.-- mV</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">ç”µæµ</div>
                            <div class="metric-value" id="metricCurrent">--.-- mA</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åŠŸç‡ç›‘æ§ -->
            <div class="card chart-card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ’¡ åŠŸç‡ç›‘æ§</h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline" onclick="toggleChart('powerChart')">
                            <span class="btn-icon">ğŸ“Š</span>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="powerChart"></canvas>
                    </div>
                    <div class="metric-row">
                        <div class="metric">
                            <div class="metric-label">è¾“å‡ºåŠŸç‡</div>
                            <div class="metric-value" id="metricPower">--.-- mW</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">æœ€å¤§åŠŸç‡</div>
                            <div class="metric-value" id="metricMaxPower">--.-- mW</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">å¹³å‡åŠŸç‡</div>
                            <div class="metric-value" id="metricAvgPower">--.-- mW</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç‰¹æ€§æ›²çº¿ -->
            <div class="card chart-card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“ˆ ç‰¹æ€§æ›²çº¿</h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline" onclick="toggleChart('characteristicChart')">
                            <span class="btn-icon">ğŸ“Š</span>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="characteristicChart"></canvas>
                    </div>
                    <div class="metric-row">
                        <div class="metric">
                            <div class="metric-label">å¡è´å…‹ç³»æ•°</div>
                            <div class="metric-value" id="metricSeebeck">--.-- mV/Â°C</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">è½¬æ¢æ•ˆç‡</div>
                            <div class="metric-value" id="metricEfficiency">--.-- %</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">RÂ²æ‹Ÿåˆåº¦</div>
                            <div class="metric-value" id="metricRSquared">--.--</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åŸå§‹æ•°æ® -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ“‹ åŸå§‹æ•°æ®</h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline" onclick="toggleRawData()">
                            <span class="btn-icon">ğŸ“„</span>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="raw-data-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>çƒ­ç«¯(Â°C)</th>
                                    <th>å†·ç«¯(Â°C)</th>
                                    <th>ç”µå‹(V)</th>
                                    <th>åŠŸç‡(mW)</th>
                                    <th>å¡è´å…‹(mV/Â°C)</th>
                                </tr>
                            </thead>
                            <tbody id="rawDataTable">
                                <tr>
                                    <td colspan="6" class="text-center">ç­‰å¾…æ•°æ®...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®é¢æ¿ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ğŸ”§ é…ç½®é¢æ¿</h2>
                </div>
                <div class="card-content">
                    <div class="config-form">
                        <div class="form-group">
                            <label for="configLoadResistance">è´Ÿè½½ç”µé˜» (Î©):</label>
                            <input type="number" id="configLoadResistance" value="10.0" step="0.1" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="configTegResistance">TEGå†…é˜» (Î©):</label>
                            <input type="number" id="configTegResistance" value="4.0" step="0.1" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="configSeebeckCoeff">å¡è´å…‹ç³»æ•° (mV/Â°C):</label>
                            <input type="number" id="configSeebeckCoeff" value="40.0" step="0.1" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="configSampleRate">é‡‡æ ·ç‡ (Hz):</label>
                            <select id="configSampleRate" class="form-control">
                                <option value="1">1 Hz</option>
                                <option value="2" selected>2 Hz</option>
                                <option value="5">5 Hz</option>
                                <option value="10">10 Hz</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="updateConfig()">
                            <span class="btn-icon">ğŸ’¾</span>
                            <span class="btn-text">ä¿å­˜é…ç½®</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="footer-content">
                <div class="footer-info">
                    <p>æ•°æ®æ›´æ–°æ—¶é—´: <span id="dataUpdateTime">--:--:--</span></p>
                    <p>æœåŠ¡å™¨: <span id="serverInfo">æœªè¿æ¥</span></p>
                </div>
                <div class="footer-actions">
                    <button class="btn btn-sm btn-outline" onclick="showSystemInfo()">
                        <span class="btn-icon">â„¹ï¸</span>
                        <span class="btn-text">ç³»ç»Ÿä¿¡æ¯</span>
                    </button>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScriptä»£ç  -->
    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let charts = {};
        let dataBuffer = [];
        let maxDataPoints = 100;
        let startTime = null;
        let isAcquisitionRunning = false;
        let isLogging = false;
        let updateInterval = null;
        
        // DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();
            
            // è¿æ¥WebSocketæœåŠ¡å™¨
            connectWebSocket();
            
            // è·å–å¯ç”¨ä¸²å£
            refreshPorts();
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            updateTime();
            setInterval(updateTime, 1000);
            
            // å¼€å§‹æ•°æ®æ›´æ–°å¾ªç¯
            startUpdateLoop();
        });
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ¸©åº¦å›¾è¡¨
            const tempCtx = document.getElementById('tempChart').getContext('2d');
            charts.tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'çƒ­ç«¯æ¸©åº¦',
                            data: [],
                            borderColor: '#ff6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'å†·ç«¯æ¸©åº¦',
                            data: [],
                            borderColor: '#36a2eb',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´ (s)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æ¸©åº¦ (Â°C)'
                            }
                        }
                    }
                }
            });
            
            // ç”µå‹å›¾è¡¨
            const voltageCtx = document.getElementById('voltageChart').getContext('2d');
            charts.voltageChart = new Chart(voltageCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'å¼€è·¯ç”µå‹',
                            data: [],
                            borderColor: '#4bc0c0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´ (s)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ç”µå‹ (V)'
                            }
                        }
                    }
                }
            });
            
            // åŠŸç‡å›¾è¡¨
            const powerCtx = document.getElementById('powerChart').getContext('2d');
            charts.powerChart = new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'è¾“å‡ºåŠŸç‡',
                            data: [],
                            borderColor: '#ff9f40',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´ (s)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'åŠŸç‡ (mW)'
                            }
                        }
                    }
                }
            });
            
            // ç‰¹æ€§æ›²çº¿å›¾è¡¨
            const charCtx = document.getElementById('characteristicChart').getContext('2d');
            charts.characteristicChart = new Chart(charCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'æ¸©å·®-ç”µå‹ç‰¹æ€§',
                            data: [],
                            borderColor: '#9966ff',
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ¸©å·® (Â°C)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ç”µå‹ (V)'
                            }
                        }
                    }
                }
            });
        }
        
        // è¿æ¥WebSocketæœåŠ¡å™¨
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                updateIndicator('indicatorServer', 'online');
                updateServerInfo('å·²è¿æ¥');
                
                // è¯·æ±‚æœ€æ–°æ•°æ®
                socket.send(JSON.stringify({
                    type: 'request_data',
                    n_points: 50
                }));
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
                }
            };
            
            socket.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                updateIndicator('indicatorServer', 'error');
                updateServerInfo('è¿æ¥é”™è¯¯');
            };
            
            socket.onclose = function() {
                console.log('WebSocketè¿æ¥å…³é—­');
                updateIndicator('indicatorServer', 'offline');
                updateServerInfo('æœªè¿æ¥');
                
                // 5ç§’åå°è¯•é‡è¿
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            if (data.type === 'new_data') {
                // æ–°æ•°æ®
                processNewData(data.data);
            } else if (data.type === 'status_update') {
                // çŠ¶æ€æ›´æ–°
                updateStatus(data.status);
            } else if (data.type === 'data_response') {
                // æ•°æ®å“åº”
                if (data.data && data.data.length > 0) {
                    data.data.forEach(processNewData);
                }
            } else if (data.type === 'acquisition_status') {
                // é‡‡é›†çŠ¶æ€
                updateAcquisitionStatus(data.status);
            } else if (data.type === 'recording_status') {
                // è®°å½•çŠ¶æ€
                updateRecordingStatus(data.status);
            } else if (data.type === 'connected') {
                // è¿æ¥æˆåŠŸ
                console.log('WebSocketè¿æ¥å·²ç¡®è®¤');
            }
        }
        
        // å¤„ç†æ–°æ•°æ®
        function processNewData(data) {
            // æ·»åŠ åˆ°æ•°æ®ç¼“å†²åŒº
            dataBuffer.push(data);
            
            if (dataBuffer.length > maxDataPoints) {
                dataBuffer.shift();
            }
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats();
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay(data);
            
            // æ›´æ–°å›¾è¡¨
            updateCharts(data);
            
            // æ›´æ–°æ•°æ®è¡¨æ ¼
            updateDataTable(data);
            
            // æ›´æ–°æ—¶é—´
            updateDataTime();
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('statDataPoints').textContent = dataBuffer.length;
            
            // è®¡ç®—é‡‡æ ·ç‡
            if (dataBuffer.length > 1) {
                const timeDiff = (dataBuffer[dataBuffer.length-1].timestamp - dataBuffer[0].timestamp) / 1000;
                const sampleRate = dataBuffer.length / Math.max(1, timeDiff);
                document.getElementById('statSampleRate').textContent = sampleRate.toFixed(1) + ' Hz';
            }
            
            // æ›´æ–°è¿è¡Œæ—¶é—´
            if (startTime) {
                const uptime = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                document.getElementById('statUptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay(data) {
            // æ¸©åº¦
            document.getElementById('metricHotTemp').textContent = data.hot_temp.toFixed(2) + ' Â°C';
            document.getElementById('metricColdTemp').textContent = data.cold_temp.toFixed(2) + ' Â°C';
            document.getElementById('metricTempDiff').textContent = data.temp_diff.toFixed(2) + ' Â°C';
            
            // ç”µå‹
            document.getElementById('metricVoltage').textContent = data.voltage.toFixed(3) + ' V';
            document.getElementById('metricVoltageRaw').textContent = data.voltage_raw.toFixed(1) + ' mV';
            document.getElementById('metricCurrent').textContent = data.current.toFixed(1) + ' mA';
            
            // åŠŸç‡
            document.getElementById('metricPower').textContent = data.power.toFixed(2) + ' mW';
            
            // ç‰¹æ€§
            document.getElementById('metricSeebeck').textContent = data.seebeck.toFixed(2) + ' mV/Â°C';
            document.getElementById('metricEfficiency').textContent = data.efficiency.toFixed(2) + ' %';
            
            // è®¡ç®—æœ€å¤§åŠŸç‡
            if (dataBuffer.length > 0) {
                const maxPower = Math.max(...dataBuffer.map(d => d.power));
                const avgPower = dataBuffer.reduce((sum, d) => sum + d.power, 0) / dataBuffer.length;
                
                document.getElementById('metricMaxPower').textContent = maxPower.toFixed(2) + ' mW';
                document.getElementById('metricAvgPower').textContent = avgPower.toFixed(2) + ' mW';
            }
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            // è®¡ç®—ç›¸å¯¹æ—¶é—´
            const timeRel = dataBuffer.map(d => (d.timestamp - dataBuffer[0].timestamp) / 1000);
            
            // æ›´æ–°æ¸©åº¦å›¾è¡¨
            charts.tempChart.data.labels = timeRel;
            charts.tempChart.data.datasets[0].data = dataBuffer.map(d => d.hot_temp);
            charts.tempChart.data.datasets[1].data = dataBuffer.map(d => d.cold_temp);
            charts.tempChart.update('none');
            
            // æ›´æ–°ç”µå‹å›¾è¡¨
            charts.voltageChart.data.labels = timeRel;
            charts.voltageChart.data.datasets[0].data = dataBuffer.map(d => d.voltage);
            charts.voltageChart.update('none');
            
            // æ›´æ–°åŠŸç‡å›¾è¡¨
            charts.powerChart.data.labels = timeRel;
            charts.powerChart.data.datasets[0].data = dataBuffer.map(d => d.power);
            charts.powerChart.update('none');
            
            // æ›´æ–°ç‰¹æ€§æ›²çº¿
            charts.characteristicChart.data.datasets[0].data = dataBuffer.map(d => ({
                x: d.temp_diff,
                y: d.voltage
            }));
            charts.characteristicChart.update('none');
        }
        
        // æ›´æ–°æ•°æ®è¡¨æ ¼
        function updateDataTable(data) {
            const table = document.getElementById('rawDataTable');
            
            // åˆ›å»ºæ–°è¡Œ
            const time = new Date(data.timestamp).toLocaleTimeString();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${time}</td>
                <td>${data.hot_temp.toFixed(2)}</td>
                <td>${data.cold_temp.toFixed(2)}</td>
                <td>${data.voltage.toFixed(3)}</td>
                <td>${data.power.toFixed(2)}</td>
                <td>${data.seebeck.toFixed(2)}</td>
            `;
            
            // æ·»åŠ åˆ°è¡¨æ ¼å¼€å¤´
            table.insertBefore(row, table.firstChild);
            
            // é™åˆ¶è¡Œæ•°
            if (table.children.length > 10) {
                table.removeChild(table.lastChild);
            }
        }
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN');
            document.getElementById('dataUpdateTime').textContent = timeStr;
        }
        
        function updateDataTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('dataUpdateTime').textContent = timeStr;
        }
        
        // æ›´æ–°æŒ‡ç¤ºå™¨
        function updateIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'indicator-dot';
            
            switch (status) {
                case 'online':
                    element.classList.add('indicator-online');
                    break;
                case 'offline':
                    element.classList.add('indicator-offline');
                    break;
                case 'error':
                    element.classList.add('indicator-error');
                    break;
            }
        }
        
        // æ›´æ–°æœåŠ¡å™¨ä¿¡æ¯
        function updateServerInfo(status) {
            document.getElementById('serverInfo').textContent = status;
        }
        
        // æ›´æ–°é‡‡é›†çŠ¶æ€
        function updateAcquisitionStatus(status) {
            if (status === 'started') {
                isAcquisitionRunning = true;
                startTime = Date.now();
                updateIndicator('indicatorAcquisition', 'online');
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnStop').disabled = false;
                document.getElementById('btnStartLogging').disabled = false;
            } else if (status === 'stopped') {
                isAcquisitionRunning = false;
                updateIndicator('indicatorAcquisition', 'offline');
                document.getElementById('btnStart').disabled = false;
                document.getElementById('btnStop').disabled = true;
            }
        }
        
        // æ›´æ–°è®°å½•çŠ¶æ€
        function updateRecordingStatus(status) {
            if (status === 'started') {
                isLogging = true;
                document.getElementById('btnStartLogging').disabled = true;
                document.getElementById('btnStopLogging').disabled = false;
                document.getElementById('currentFileName').textContent = 'è®°å½•ä¸­...';
            } else if (status === 'stopped') {
                isLogging = false;
                document.getElementById('btnStartLogging').disabled = false;
                document.getElementById('btnStopLogging').disabled = true;
                document.getElementById('currentFileName').textContent = 'æœªè®°å½•';
            }
        }
        
        // è·å–å¯ç”¨ä¸²å£
        async function refreshPorts() {
            try {
                const response = await fetch('/api/ports');
                const ports = await response.json();
                
                const select = document.getElementById('portSelect');
                select.innerHTML = '<option value="">è‡ªåŠ¨æ£€æµ‹</option>';
                
                ports.forEach(port => {
                    const option = document.createElement('option');
                    option.value = port.port;
                    option.textContent = `${port.port} - ${port.description}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('è·å–ä¸²å£åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // è¿æ¥ä¸²å£
        async function connectSerial() {
            const port = document.getElementById('portSelect').value;
            const baudrate = document.getElementById('baudrateSelect').value;
            
            try {
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        port: port || undefined,
                        baudrate: parseInt(baudrate)
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateIndicator('indicatorSerial', 'online');
                    document.getElementById('btnConnect').disabled = true;
                    document.getElementById('btnDisconnect').disabled = false;
                    document.getElementById('btnStart').disabled = false;
                    
                    alert('ä¸²å£è¿æ¥æˆåŠŸ');
                } else {
                    alert('ä¸²å£è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                console.error('è¿æ¥ä¸²å£å¤±è´¥:', error);
                alert('è¿æ¥ä¸²å£å¤±è´¥: ' + error.message);
            }
        }
        
        // æ–­å¼€ä¸²å£
        async function disconnectSerial() {
            try {
                await fetch('/api/disconnect', {
                    method: 'POST'
                });
                
                updateIndicator('indicatorSerial', 'offline');
                document.getElementById('btnConnect').disabled = false;
                document.getElementById('btnDisconnect').disabled = true;
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnStop').disabled = true;
                
                alert('ä¸²å£å·²æ–­å¼€');
            } catch (error) {
                console.error('æ–­å¼€ä¸²å£å¤±è´¥:', error);
            }
        }
        
        // å¼€å§‹æ•°æ®é‡‡é›†
        function startAcquisition() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'start_acquisition'
                }));
            } else {
                alert('WebSocketæœªè¿æ¥');
            }
        }
        
        // åœæ­¢æ•°æ®é‡‡é›†
        function stopAcquisition() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'stop_acquisition'
                }));
            }
        }
        
        // å¼€å§‹è®°å½•æ•°æ®
        function startLogging() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `teg_data_${timestamp}.csv`;
                
                socket.send(JSON.stringify({
                    type: 'start_recording',
                    filename: filename
                }));
                
                document.getElementById('currentFileName').textContent = filename;
            }
        }
        
        // åœæ­¢è®°å½•æ•°æ®
        function stopLogging() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'stop_recording'
                }));
            }
        }
        
        // æ¸…ç©ºæ•°æ®
        function clearData() {
            if (isAcquisitionRunning) {
                alert('è¯·å…ˆåœæ­¢æ•°æ®é‡‡é›†');
                return;
            }
            
            dataBuffer = [];
            
            // æ¸…ç©ºå›¾è¡¨
            Object.values(charts).forEach(chart => {
                chart.data.labels = [];
                chart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                chart.update();
            });
            
            // æ¸…ç©ºè¡¨æ ¼
            document.getElementById('rawDataTable').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">ç­‰å¾…æ•°æ®...</td>
                </tr>
            `;
            
            // é‡ç½®æ˜¾ç¤º
            document.querySelectorAll('.metric-value').forEach(el => {
                if (el.id.startsWith('metric')) {
                    el.textContent = '--.--' + (el.id.includes('Temp') ? ' Â°C' : 
                                               el.id.includes('Voltage') ? ' V' :
                                               el.id.includes('Current') ? ' mA' :
                                               el.id.includes('Power') ? ' mW' :
                                               el.id.includes('Seebeck') ? ' mV/Â°C' :
                                               el.id.includes('Efficiency') ? ' %' : '');
                }
            });
            
            document.getElementById('statDataPoints').textContent = '0';
            document.getElementById('statSampleRate').textContent = '0.0 Hz';
            document.getElementById('statUptime').textContent = '00:00:00';
            
            alert('æ•°æ®å·²æ¸…ç©º');
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            if (dataBuffer.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            try {
                // è½¬æ¢ä¸ºCSVæ ¼å¼
                const headers = ['æ—¶é—´æˆ³', 'çƒ­ç«¯æ¸©åº¦', 'å†·ç«¯æ¸©åº¦', 'æ¸©å·®', 'ç”µå‹', 'ç”µæµ', 'åŠŸç‡', 'å¡è´å…‹ç³»æ•°', 'æ•ˆç‡'];
                const rows = dataBuffer.map(d => [
                    d.timestamp,
                    d.hot_temp,
                    d.cold_temp,
                    d.temp_diff,
                    d.voltage,
                    d.current,
                    d.power,
                    d.seebeck,
                    d.efficiency
                ]);
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `teg_export_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('æ•°æ®å¯¼å‡ºå®Œæˆ');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                alert('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–°é…ç½®
        async function updateConfig() {
            const loadResistance = document.getElementById('configLoadResistance').value;
            const tegResistance = document.getElementById('configTegResistance').value;
            const seebeckCoeff = document.getElementById('configSeebeckCoeff').value;
            const sampleRate = document.getElementById('configSampleRate').value;
            
            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        load_resistance: parseFloat(loadResistance),
                        teg_resistance: parseFloat(tegResistance),
                        seebeck_coefficient: parseFloat(seebeckCoeff)
                    })
                });
                
                // æ›´æ–°é‡‡æ ·ç‡
                clearInterval(updateInterval);
                updateInterval = setInterval(() => {
                    if (socket && socket.readyState === WebSocket.OPEN && isAcquisitionRunning) {
                        socket.send(JSON.stringify({
                            type: 'request_data',
                            n_points: 1
                        }));
                    }
                }, 1000 / sampleRate);
                
                alert('é…ç½®å·²æ›´æ–°');
            } catch (error) {
                console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
                alert('æ›´æ–°é…ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ‡æ¢å›¾è¡¨æ˜¾ç¤º
        function toggleChart(chartId) {
            const chart = charts[chartId];
            const canvas = document.getElementById(chartId);
            
            if (canvas.style.display === 'none') {
                canvas.style.display = 'block';
                chart.resize();
            } else {
                canvas.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢åŸå§‹æ•°æ®æ˜¾ç¤º
        function toggleRawData() {
            const table = document.getElementById('rawDataTable').parentNode.parentNode;
            if (table.style.display === 'none') {
                table.style.display = 'block';
            } else {
                table.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢å…¨å±
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`å…¨å±è¯·æ±‚å¤±è´¥: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        function showSystemInfo() {
            const info = `
                ç³»ç»Ÿä¿¡æ¯:
                - æ•°æ®ç‚¹æ•°: ${dataBuffer.length}
                - ç¼“å†²åŒºå¤§å°: ${maxDataPoints}
                - é‡‡æ ·ç‡: ${document.getElementById('statSampleRate').textContent}
                - è¿è¡Œæ—¶é—´: ${document.getElementById('statUptime').textContent}
                - WebSocketçŠ¶æ€: ${socket ? socket.readyState : 'æœªè¿æ¥'}
                - é‡‡é›†çŠ¶æ€: ${isAcquisitionRunning ? 'è¿è¡Œä¸­' : 'åœæ­¢'}
                - è®°å½•çŠ¶æ€: ${isLogging ? 'è®°å½•ä¸­' : 'åœæ­¢'}
            `;
            
            alert(info);
        }
        
        // å¼€å§‹æ›´æ–°å¾ªç¯
        function startUpdateLoop() {
            const sampleRate = document.getElementById('configSampleRate').value;
            updateInterval = setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN && isAcquisitionRunning) {
                    socket.send(JSON.stringify({
                        type: 'request_data',
                        n_points: 1
                    }));
                }
            }, 1000 / sampleRate);
        }
        
        // é¡µé¢å¸è½½å‰æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.close();
            }
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>